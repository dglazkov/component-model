<html>
<head>
    <title>Component Model - Rendering</title>

    <link rel=stylesheet type=text/css href=../css/spec.css>
</head>
<body>

<h3>Element registration</h3>

<h4>The Element Registration API</h4>

<p>This section is non-normative.</p>

<p>The element registration API is a set of markup and DOM interfaces which register a new HTML element, its appearance and behavior.
By using the element registion API, authors can register new element names to user agents. 
After the registration, user agents recognize each registered element.</p>

<!-- TODO(morrita): mentions lifecycle section -->
<!-- TODO(morrita): mentions element script -->

<p>The <code>element</code> element registers a new element which can be used inside a Web page.
Each new element may have a constructor function and a set of lifecycle callback which is invoked in the element lifecycle.</p>

<p>The <code>element</code> can have the <code>script</code> element and the <code>template</code> as its child:</p>

<ul>
  <li><p>The <code>script</code> element is designed to be used for defining a constructor for the element. 
  Authors can register a constructor for the registered element through the script.</p></li>
  <li><p>The <code>template</code> element holds HTML fragment. 
  The fragment is used as a template for shadow tree of the registered element.
  Templates are cloned and inserted as a children of the shadow root of the element.</p></li>
</ul>

<!-- TODO(morrita): generalize the template mechanism -->

<h4>The element element</h4>

<dl class="element">
  <dt>Categories:</dt>
  <dd>Metadata Element</dd>

  <dt>Contexts in which this element can be used:</dt>
  <dd>Where metadata content is expected.</dd>

  <dt>Content attributes:</dt>
  <dt><code><a href="">for</a></code></dt>

  <dt>DOM interface:</dt>
  <dd><pre class="idl">

[Callback]
interface HTMLElementCloser {
  void close(HTMLElement element, ShadowRoot shadow);
};

[Callback]
interface HTMLElementOpener {
  HTMLElement open();
};

interface HTMLElementElement : HTMLElement {
           attribute DOMString forName;
  readonly attribute HTMLTemplateElement template;
           attribute HTMLElementOpener opener;
           attribute HTMLElementCloser closer;

  HTMLElement create();
};
  
  </pre></dd>
</dl>

<p>The <code>element</code> element allows author to register a new element. 
The registered element is available once the <code>elememnt</code> element is closed.
The name of the element is given by the <code>for</code> attribute. 
Thus the <code>for</code> value should be valid as an element name.</p>

<p>The tree construction algorithm on the user agent recognizes 
the name of each registered elements as an element name in HTML namespace. 
The algorithm <a href="">create an element for the token</a>. 
A node to be inserted is created according to the <a href="">registered element creation algorithm</a>.</p>

<p>Each <code>element</code> element has at most one <dfn>associated tempalte element</dfn>.
An associated <code>template</code> element is the first child <code>template</code> element whose 
parent is the <code>element</code> element.</p>

<p>Each <code>element</code> element can have a opener and a closer.
The initial values of the construdtor and the closer is value null.</p>

<div class="impl">
<p>The <dfn>forName</dfn> IDL attribute must reflect the <code>for</code> content attribute.</p>
<p>The <dfn>template</dfn> IDL attribute returns an <a href="">associated template element</a>.</p>
<p>The <dfn>opener</dfn> IDL attribute returns or sets an <a href="">associated opener callback</a>. The initial value of the attribute is null.</p>
<p>The <dfn>closer</dfn> IDL attribute returns or sets an <a href="">associated closer callback</a>. The initial value of the attribute is null.</p>
<p>The <dfn>create()</dfn> method, when invoked, executes the <a href="">registered element creation algorithm</a>, and returns the created element.</p>
</div>

<h5>The registered element creation algorithm.</h5>
Each time a new instance of the registered element is required, user agents execute the registered element creation algorithm which is following:

<!-- TODO(morrita): What if the element constructor want to access its attributes? -->

<ol>
  <li><p>Execute an associated opener callback if it's not null, or execute the <a href="">default opener algorithm</a>.</p></li>
  <li><p>Varify element's <a href="">context validity</a>. 
  <ol>
  </ol>
  If the element isn't valid, execute the <a href="">default opener algorithm</a>, which must return a valid element.</p></li>
  <li><p>If the execution is invoked from the tree construction algorithm, return the valid element, 
      and continue the algorithm until the element is closed, call the associated element closer unless it is null.</p></li>
  <li><p>If the execution is invoked from elsewhere, call the associated element closer unless it is null. Then return the valid element.</p></li>
</ol>

<p>The <code>element</code> parameter of the closer callback is the valid element which was created a previous step.
<code>shadow</code> parameter is an ShadowRoot instance which is associated to the valid element.
The <code>shadow</param> parameter can be null.</p>

<p>The <code>default opener algorithm</code> is as follows:

<ol>
  <li><p>Create an instance of HTMLElement interface.</p></li>
  <li><p>Let the name of the elment to be <code>forName</code> IDL attribute of the registered element.</p></li>
  <li><p>If the registered element has non-null assocaited template,
      create a ShadowRoot instance with the created element and the associated template.</p></li>
  <li><p>Return the created element instance.</p></li>
</ol>

<p>The element instance satisfies the content validity if:</p>
<ol>
  <li><p>The interface implements HTMLElement interface or implements an interface which is inherited from HTMLElement.</p></li>
  <li><p>The element name, which is accessible from <code>tagName</code> attribute, matches the <code>forName</code> IDL attribute.</p></li>
</ol>

<!-- TODO(morrita): Mentions about "new"-ness -->

<h4>The Element Script</h4>

<!-- TODO(morrita): Overview? -->

<h5>HTMLElementRegistrar</h5>

<code>HTMLElementRegistrar</code> provides a set of convenienct API which is only usable during the element script execution.
User agent implements the <code>HTMLElementRegistrar</code> interface on <code>HTMLElement</code> object.

<dl class="element">
  <dt>DOM interface:</dt>
  <dd><pre class="idl">

[Callback]
interface HTMLElementRegistrar {
  static readonly attribute HTMLElementElement registering;
  static void register(HTMLElementOpener opener, [Optional] HTMLElementCloser closer);
};
  
  </pre></dd>
</dl>

<p>The element script is a script created by a <code>script</code> element which has an <code>element</code> element as a parent.
The elemetn script is created as usual <code>script</code>, but it also has following preprocess and postprocess step.</p>

<dl>
  <dt>Preprocess step:</dt>
  <dd><p></p></dd>
</dl>

</body>
</html>
